# Интеграция

## Настройка со стороны нашего билинга:

Чтоб активировать режим, нужно навесить на дилерский договор 2 услуги:

* Дилер - Абонент завжди активний
* Дилер - Відключати IPTV послуги

## Ожидаемый Workflow со стороны стороннего билинга:

Перед выполнением любого запроса, необходимо авторизоваться оператором, получив токен.
Все следующие запросы нужно выполнять, указав полученный токен в заголовках.

```http request
POST https://<host>/v1/tokens
Content-Type: application/json

{
    "login": "{login}",
    "password": "{password}"
}
``` 

### Получение списка пакетов

Т.к. наш билинг позволяет настроить специальный тариф для каждой "Точки подключения" абонента индивидуально, 
наиболее правдивая информация о доступных услугах - при обращении непосредственно к абоненту:

```http request
GET http://{host}/v1/objects/{account_id}
Authorization: Bearer {auth_token}
```

Но для случаев, когда абонента еще не существует, но список услуг уже нужен, можно получить список услуг "по умолчанию": 

```http request
GET http://{host}/v1/search/bundles
Authorization: Bearer {auth_token}
```

### Создание нового абонента

Ни одно из полей не является обязательным, но крайне рекомендуется для вашего удобства заполнять как можно полнее:

```http request
POST https://{host}/v1/objects
Authorization: Bearer {auth_token}
Content-Type: application/json

{
  "first_name": "Developer",
  "middle_name": "None",
  "last_name": "Test",
  "note": "Developer Test",
  "phone": "000 0000000",
  "password": "000000"
}
```

### Получение информации об абоненте

Одним запросом можно получить всю необходиую информацию: ID абонента, статус, баланс, контакты, 
доступные пакеты `bundles`, активные пакеты `services`, созданные плейлисты `playlists` и устройства `devices`: 

```http request
GET http://{host}/v1/objects/{account_id}
Authorization: Bearer {auth_token}
```

### Включить услугу

В режиме "Интеграция" выбранная услуга включается сразу, независимо от того, хватает средств на счету абонента или нет:
Ключ `auto_renewal: 1` здесь обязателен. При включении услуги, со счета абонента будет списана сумма, пропорциональная
сумме и количеству дней, оставшихся до конца календарного месяца:

```http request
POST https://{host}/v1/objects/{account_id}/services
Authorization: Bearer {auth_token}
Content-Type: application/json

{
  "id": 127,
  "auto_renewal": 1
}
```

// TODO Дополнительные услуги

### Смена активной услуги на другую

Активную услугу можно сменить на более "дорогую", которая выше в иерархии услуг. Например, при получении списка услуг,
в `bundles` видим, что "Комфорт" уже содержит в себе 2 услуги: 126 ("Базовый"), и 100 ("Социальный"). В этом списке 
вы так же можете видеть ID пакетов, которых нет в списке доступных вам пакетов, не обращайте внимания, это устаревшие
уже неактивные пакеты, они со временем исчезнут. Вы все равно не можете на них переключиться при всем желании. 

```json
{
      "id": "127",
      "main": "1",
      "bundles": [
        "126",
        "100"
      ],
      "name_ru": "Комфорт",
      "name_uk": "Комфорт",
      "channels_count": 226,
      "cost": "99.00"
    }
```

Это значит, что если у абонента "Комфорт", то переключиться на "Базовый" или "Стандарт" он не может просто так,
не отключив предварительно активный пакет. То есть следующий запрос вернет статус 200, но "Социальный" не включит, 
т.к. он уже входит в активный "Комфорт":

```http request
POST https://{host}/v1/objects/{account_id}/services
Authorization: Bearer {auth_token}
Content-Type: application/json

{
  "id": 100,
  "auto_renewal": 1
}
```

Тут важно обращать внимание на флаг `active: 1|0` - именно он сигнализирует, удалось сменить услугу или нет.

При этом смена услуги на более дорогую "Премиум" пройдет без проблем:

```http request
POST https://{host}/v1/objects/{account_id}/services
Authorization: Bearer {auth_token}
Content-Type: application/json

{
  "id": 128,
  "auto_renewal": 1
}
```

Если же нужно сменить услугу на более дешевую, нужно предварительно отключить активную (см. следующий раздел),
при этом неиспользованные средства, списанные за пакет до конца месяца вернутся на счет. Такое не совсем удобное
поведение обусловлено существующей бизнес-логикой работы услуг для "[Классического](type-classic.md)" типа дилерского
аккаунта. Так же важно обращать внимание на параметр `auto_renewal`, он всегда должен быть равен `1` при активации
услуги. По вышеназванным причинам. 

### Отключение существующей услуги

В данном режиме услуга отключается сразу по запросу оператора (в "Классическом" - отключается только в конце месяца).
Неиспользованные средства, списанные за услугу, возвращаются на счет абонента. Текущий день не учитывается. Обратите 
внимание, даже если услуга была активна 1 сек, но сразу была отключена - со счета списывается сумма за 1 день работы
услуги. Такое решение было предусмотрено чтобы пресечь хитрость абонента, который утром включал бы услугу, а вечером 
выключал, и получал бы день бесплатно. Отсюда - несколько услуг, включенных и отключенных в течение одного дня,
списывают со счета абонента свою стоимость за день каждая!

Отключить услугу просто:

```http request
DELETE https://{host}/v1/objects/{account_id}/services/127
Authorization: Bearer {auth_token}
```

### Плейлисты и устройства

Для того, чтоб воспользоваться услугой ОТТ, абонент должен иметь созданное "устройство", либо "плейлист".
Плейлист позволяет смотреть трансляцию с приложений, где не требуется авторизация (VLC и ему подобные приложения
на ПК, некоторые типы ТВ-приставок, ...). Устройство же необходимо для нашего приложения 
[Prosto.TV](https://play.google.com/store/apps/details?id=iptv.prosto.tv) и имеет логин и пароль, которое потребует 
приложение для авторизации.

В создании, редактировании, удалении устройств нет ничего сложного, вы можете ознакомиться с необходимыми параметрами
запроса в [Документации к АПИ](https://docs.api.prosto.tv).

У абонента может быть не более 5 устройств (или плейлистов). При попытке создать свыше лимита будет сообщение об ошибке.

В приложении у абонента есть возможность войти с помощью номера телефона (если он вдруг забыл пароль), убедитесь
что вы указали правильный номер телефона при создании абонента (номер телефона можно так же изменить позже, 
см. документацию к АПИ). Но может случиться, что абонент для восстановления пароля введет другой номер телефона.
По регламенту, если номер телефона нам неизвестен, мы создаем новую учетку и отправляем абоненту логин-пароль через СМС.

Тут два варианта - если он сделал это из диапазона IP адресов, который закреплен за вами - он автоматически попадает 
в вашу область видимости. Если нет - то к нам. Мы периодически отслеживаем новых абонентов, которые были созданы 
автоматически и попали к вам, и уведомляем вас об этом, чтоб обратили внимание. 

Если вы не хотите, чтоб самостоятельно активированные абоненты попадали к вам в учетку - вы можете сообщить нам об этом.

При самостоятельной регистрации абоненту присваивается пакет "Премиум", сроком на 7 дней, после чего он переводится
на бесплатный пакет "Социальный", о чем приходит уведомление в приложении.

### Удаление абонента

Не удаляйте абонента. Пока не будете уверены, что он никогда больше не вернется. Но если очень нужно, вы можете
сделать это следующим запросом. Только подумайте, действительно ли это вам нужно. Учтите, что восстановить удаленного 
абонента будет непросто. При удалении, с абонента удаляются все услуги, в т.ч. системные, которые определяют его
поведение.   

```http request
DELETE https://{host}/v1/objects/{account_id}
Authorization: Bearer {auth_token}
```

Не рекомендуется так же отключать абонента. В "[Классической](type-classic.md)" схеме отключить / активировать
абонента намного проще, но в "Интеграционной" схеме абонент всегда "в минусе", и при попытке активировать, его учетка 
остается заблокирована до тех пор, пока счет отрицательный. 

Когда абонент отказывается пользоваться услугой ОТТ, рекомендуется просто отключать ему услугу (см. выше), 
а при повторном обращении снова включать. Активные абоненты без услуги - не считаются при ежемесячной сверке.

При острой необходимости отключить абонента рекомендуется следующая последовательность действий:

```http request
POST https://{host}/v1/objects/{account_id}/status
Authorization: Bearer {auth_token}
Content-Type: application/json

{
  "status": "disconnected"
}
```

Абонент отключен, вы можете его включить обратно:

```http request
POST https://{host}/v1/objects/{account_id}/status
Authorization: Bearer {auth_token}
Content-Type: application/json

{
  "status": "active"
}
```

Но пока у него минус на счету, абонент буде заболкирован. Достаточно вывести его счет в `0.00`, и абонент активируется:

```http request
POST http://{host}/v1/objects/{account_id}/operations
Authorization: Bearer {auth_token}
Accept: application/json

{
  "sum": "14.73"
}
```

Не беспокойтесь, эти средства учтутся при сверке. В данной схеме работы это единственный случай, когда вам может 
понадобиться пополнение счета абонента. Поэтом ранее в тексте не встречается. Уточню, что этим запросом вы реально 
никакие средства никуда не перечисляете, это ваша гарантия, как дилера, вы "ручаетесь", что указанные средства за услугу
оплачены абонентом.

## Relations между ID абонента в нашем билинге и билинге внешнем

На данный момент на нашей стороне не реализовано хранение внешнего ID стороннего билинга. 
Пока договорились, что предпочтительно хранить наш ID на стороне внешнего билинга. Но в обратном случае, 
при необходимости, внешний билинг может хранить свой уникальный ID в доступных полях абонента, по которым возможен поиск
(см. [документацию](https://docs.api.prosto.tv/#search_accounts_post)). Например, в редко используемом свойстве 
`middle_name`, либо `comment` (последнее не рекомендуется, т.к. `comment` предполагается многострочным полем).

Естественно, при таком подходе, за уникальностью ID, записанного в информационных свойствах абонента, 
следит внешний билинг.

